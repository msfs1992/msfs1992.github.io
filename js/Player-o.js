const FPS=60;const SPEED_RATIO=4;const LOOP_MODE=false;const FROM_FRAME=0;const TO_FRAME=100;const GROUND_SIZE=50;const OCTAVES=8;let divFps=document.getElementById("fps");let divVertices=document.getElementById("Vertices");let divFaces=document.getElementById("Faces");let divObjects=document.getElementById("Objects");let engine;var terrainWidth=200;var terrainDepth=200;var terrainSubdivisions=50;var terrainMinHeight=-2;var terrainMaxHeight=30;var explosionParticleSystem;var scene;var wallMatrix=[[1,1,1,1,1,1],[1,1,1,1,1,1],[1,1,1,1,1,1],[1,1,1,1,1,1],[1,1,1,1,1,1],[1,1,1,1,1,1],[1,1,1,1,1,1],[1,1,1,1,1,1],[1,1,1,1,1,1],[1,1,0,0,1,1],[1,1,0,0,1,1],[1,1,0,0,1,1],[1,1,0,0,1,1],[1,1,0,0,1,1],[1,1,0,0,1,1],[1,1,0,0,1,1],[1,1,0,0,1,1],[1,1,0,0,1,1],[1,1,0,0,1,1],[1,1,0,0,1,1]];var heightData;var ammoheightData;class Player{t=100;debug=false;i;h;brickshape;l;o;m=[];u=[];B;A;p=false;O;L=false;N=Date.now();Y=false;v=new BABYLON.Quaternion(0,0,0,1);_=false;k=false;M=Date.now();P=false;R=false;C;S=null;T;D;G;F=[];H;I=false;j=Date.now();W=false;U=new BABYLON.Vector3(0,0,0);Z=new BABYLON.Quaternion(0,0,0,1);K=false;V=Date.now();J;q={shift:false,f:false,w:false,X:false};$=[];animations=[];tt=[];st=[];et="";it="";ht=[];nt=false;lt;ot;rt=false;ut=false;ct=false;ft=null;Bt=false;wt=8;At=4;dt=8;Ot;Lt;gt=false;Nt;Yt;yt=false;bt=false;vt=0;_t=1;kt=false;xt=Date.now();Mt=null;Pt=null;Rt=null;Ct=null;St=null;meshes=[];Tt=false;Dt={x:-.04,y:.06,z:.06};Gt={x:1.51,y:-3.14,z:.72};Ft={x:.019,y:-.04,z:-.22};Et={x:1.946,y:2.896,z:-.536};zt={x:.019,y:-.04,z:-.22};Ht={x:1.793,y:3.11,z:-.536};It=false;jt={x:0,y:.23,z:-.18};Wt={x:-1.547,y:0,z:0};Ut={x:-.08,y:.08,z:.24};Zt={x:1.05,y:-1.73,z:-1.54};grenadeShape;Kt;Vt;Jt=1.1;Qt=1;qt=60;Xt=2;$t=false;ts=null;ss=new BABYLON.Vector3;es=false;hs=false;ns=false;ls;os;rs=new BABYLON.Vector3;us=false;cs=Date.now();fs;Bs=[];ws;As=new Ammo.btTransform;ds=false;ps=Date.now();Os="idle0";Ls=[];gs;Ns=false;Ys={meshes:[]};constructor(t,s,e){scene=t;engine=e;this.A=s;setInterval((function(){divFps.innerHTML="<b>FPS: "+engine.getFps().toFixed()+"</b>";let t=scene.getTotalVertices();let s=scene.getActiveIndices()/3;let e=scene.getActiveMeshes().length;divVertices.innerHTML="<b>Vertices: "+t+"</b>";divFaces.innerHTML="<b>Faces: "+s+"</b>";divObjects.innerHTML="World Objects: <b>"+e+"</b>"}),3e4);fetch("particles/systems/linearFire.json").then((t=>t.text())).then(this.ys.bind(this));fetch("particles/systems/explosion.json").then((t=>t.text())).then(this.bs.bind(this));this.B=BABYLON.Mesh.CreateBox("skyBox",1e3,scene);var i=new BABYLON.StandardMaterial("skyBox",scene);i.backFaceCulling=false;i.reflectionTexture=new BABYLON.CubeTexture("textures/TropicalSunnyDay",scene);i.reflectionTexture.coordinatesMode=BABYLON.Texture.SKYBOX_MODE;i.diffuseColor=new BABYLON.Color3(0,0,0);i.specularColor=new BABYLON.Color3(0,0,0);i.disableLighting=true;this.B.material=i;this.Nt=new BABYLON.HighlightLayer("hl1",scene,{vs:false});this.Nt._s=false;if(!this.debug){this.ks=new BABYLON.UniversalCamera("camera1",new BABYLON.Vector3(0,5,-10),scene)}else{this.ks=new BABYLON.ArcRotateCamera("camera1",Math.PI/2,Math.PI/4,3,new BABYLON.Vector3(0,1,0),scene);this.ks.attachControl(this.A,true);this.ks.lowerRadiusLimit=2;this.ks.upperRadiusLimit=10;this.ks.wheelDeltaPercentage=.01}this.ks.attachControl(this.A,true);let h=new BABYLON.Texture("./textures/decal-diffuse.png",scene);this.ws=new BABYLON.StandardMaterial("decalMat",scene);this.ws.diffuseTexture=h;this.ws.diffuseColor=new BABYLON.Color3(0,0,0);this.ws.diffuseTexture.hasAlpha=true;this.ws.zOffset=-2;this.xs();console.log("00");this.Ms()}bs(t){explosionParticleSystem=JSON.parse(t)}ys(t){this.o=JSON.parse(t)}Ps(t){if(this.meshes!=undefined){window.ammoPlugin.world.stepSimulation(this.i,10);for(let t=0,s=this.meshes.length;t<s;t++){const s=this.meshes[t];const e=s.metadata.physicsBody;const i=e.getMotionState();if(i){i.getWorldTransform(this.As);const t=this.As.getOrigin();const h=this.As.getRotation();if(s.metadata.tag=="barrel"){if(this.It){this.It=false;e.setLinearVelocity(new Ammo.btVector3(0,0,0));e.clearForces();e.setLinearVelocity(new Ammo.btVector3(0,10,0))}else{s.position.copyFrom(new BABYLON.Vector3(t.x(),t.y(),t.z()));let e=new BABYLON.Quaternion(h.x(),h.y(),h.z(),1);s.rotation.copyFrom(e)}}else{s.position.copyFrom(new BABYLON.Vector3(t.x(),t.y(),t.z()));let e=new BABYLON.Quaternion(h.x(),h.y(),h.z(),1);s.rotation.copyFrom(e)}}}}}Rs(){BABYLON.SceneLoader.ImportMeshAsync(null,"./models/","Grenade-soviet-low.glb",scene).then((t=>{this.H=t;for(let t in this.H.meshes){this.H.meshes[t].position.y-=1;this.H.meshes[t].rotationQuaternion=null}this.H.meshes[0].id="__tgrenade1__";this.H.meshes[1].id="__tgrenadeshape1__";this.H.meshes[0].name="__tgrenade1__";this.H.meshes[1].name="__tgrenadeshape1__"}))}Cs(){BABYLON.SceneLoader.ImportMeshAsync(null,"./models/","Grenade-soviet-low.glb",scene).then((t=>{this.Ss=t;let s=new BABYLON.Vector3(this.Dt.x,this.Dt.y,this.Dt.z);let e=new BABYLON.Quaternion(this.Gt.x,this.Gt.y,this.Gt.z,1);this.W=true;for(let t in this.Ss.meshes){this.Ss.meshes[t].attachToBone(this.Pt,this.St[0]);this.Ss.meshes[t].position.copyFrom(s);this.Ss.meshes[t].rotationQuaternion=null;this.Ss.meshes[t].rotation.copyFrom(e)}this.Ss.meshes[0].id="__tgrenade__";this.Ss.meshes[1].id="__tgrenadeshape__";this.Ss.meshes[0].name="__tgrenade__";this.Ss.meshes[1].name="__tgrenadeshape__"}))}async Ts(t,s,e,i,h,n,l,o,a=false){const r=1;const m=1;const u="PHY_FLOAT";t.bakeCurrentTransformIntoVertices();const c=t.getVerticesData(BABYLON.VertexBuffer.PositionKind);o.Ds=Ammo._malloc(4*s*e);let f=0,B=0;for(let t=0;t<c.length/3;t++){f=c[t*3+1];Ammo.HEAPF32[o.Ds+B>>2]=f;B+=4}const w=new Ammo.btHeightfieldTerrainShape(s,e,o.Ds,r,i,h,m,u,a);const A=n/(s-1);const d=l/(e-1);w.Gs(new Ammo.btVector3(A,1,d));w.setMargin(BABYLON.SceneManager.DefaultHeightFieldMargin);return w}Ms(){console.log("11");var t=new BABYLON.TerrainMaterial("terrainMaterial",scene);t.specularColor=new BABYLON.Color3(.5,.5,.5);t.specularPower=64;t.Fs=new BABYLON.Texture("textures/mixMap.png",scene);t.diffuseTexture1=new BABYLON.Texture("textures/floor.png",scene);t.diffuseTexture2=new BABYLON.Texture("textures/rock.png",scene);t.diffuseTexture3=new BABYLON.Texture("textures/grass.png",scene);t.bumpTexture1=new BABYLON.Texture("textures/floor_bump.png",scene);t.bumpTexture2=new BABYLON.Texture("textures/rockn.png",scene);t.bumpTexture3=new BABYLON.Texture("textures/grassn.png",scene);t.diffuseTexture1.uScale=t.diffuseTexture1.vScale=10;t.diffuseTexture2.uScale=t.diffuseTexture2.vScale=10;t.diffuseTexture3.uScale=t.diffuseTexture3.vScale=10;console.log(22);let s=BABYLON.MeshBuilder.CreateGroundFromHeightMap("groundextension","./textures/island1.png",{width:200,height:200,subdivisions:200,updatable:true,maxHeight:2,minHeight:-2,onReady:()=>{console.log("Ground Ready ");const t=new BABYLON.StandardMaterial("myMaterial2",scene);t.diffuseTexture=new BABYLON.Texture("./textures/grass.jpg",scene);console.log(33);s.material=t;this.Es(s,new BABYLON.Vector3(200,-1.1,0))},zs:scene});let e=BABYLON.MeshBuilder.CreateGroundFromHeightMap("ground","./textures/island1.png",{width:200,height:200,subdivisions:200,updatable:true,maxHeight:2,minHeight:-2,onReady:()=>{e.position.copyFrom(new BABYLON.Vector3(0,0,0));e.material=t;this.Es(e,new BABYLON.Vector3(0,0,0));var s=BABYLON.Mesh.CreateGround("waterMesh",30,200,32,scene,false);s.position.copyFrom(new BABYLON.Vector3(50,-3,0));var i=new BABYLON.WaterMaterial("water",scene,new BABYLON.Vector2(1024,1024));i.backFaceCulling=true;i.bumpTexture=new BABYLON.Texture("./textures/water/waterbump.png",scene);i.windForce=-10;i.waveHeight=.6;i.bumpHeight=.2;i.waveLength=.5;i.colorBlendFactor=0;i.addToRenderList(this.B);i.addToRenderList(e);s.material=i;console.log("LOADING MAP OBJECTS");this.Hs()}},scene)}Is(t,s,e,i){let h=t[1].getVerticesData(BABYLON.VertexBuffer.PositionKind);let n=t[1].getVerticesData(BABYLON.VertexBuffer.NormalKind);let l=t[1].getVerticesData(BABYLON.VertexBuffer.ColorKind);let o=t[1].getVerticesData(BABYLON.VertexBuffer.UVKind);let a=t[1].getIndices();t[1].updateFacetData();var r=t[1].getFacetLocalPositions();var m=r.length;let u=new Ammo.btTriangleMesh;let c=true;let f=new Ammo.btVector3(0,0,0);let B=new Ammo.btVector3(0,0,0);let w=new Ammo.btVector3(0,0,0);var A=0;while(A<m){var d=A++;var p=a[d*3];var O=a[d*3+1];var L=a[d*3+2];var g=new Ammo.btVector3(h[p*3],h[p*3+1],h[p*3+2]);var N=new Ammo.btVector3(h[O*3],h[O*3+1],h[O*3+2]);var Y=new Ammo.btVector3(h[L*3],h[L*3+1],h[L*3+2]);u.addTriangle(g,N,Y)}let y=new Ammo.btBvhTriangleMeshShape(u,true,true);let b=new Ammo.btVector3(0,0,0);y.calculateLocalInertia(i,b);y.setMargin(0);let v=new Ammo.btTransform;v.setIdentity();v.setOrigin(new Ammo.btVector3(e.x,e.y,e.z));let _=new Ammo.btDefaultMotionState(v);let k=new Ammo.btRigidBodyConstructionInfo(i,_,y,b);let x=new Ammo.btRigidBody(k);for(let s in t){t[s].metadata={physicsBody:null};t[s].rotationQuaternion=null;t[s].metadata.physicsBody=x}window.ammoPlugin.world.addRigidBody(x);this.meshes.push(t[0])}Es(t,s){let e=t.getVerticesData(BABYLON.VertexBuffer.PositionKind);let i=t.getVerticesData(BABYLON.VertexBuffer.NormalKind);let h=t.getVerticesData(BABYLON.VertexBuffer.ColorKind);let n=t.getVerticesData(BABYLON.VertexBuffer.UVKind);let l=t.getIndices();t.updateFacetData();var o=t.getFacetLocalPositions();var a=o.length;let r=new Ammo.btTriangleMesh;let m=true;let u=new Ammo.btVector3(0,0,0);let c=new Ammo.btVector3(0,0,0);let f=new Ammo.btVector3(0,0,0);var B=0;while(B<a){var w=B++;var A=l[w*3];var d=l[w*3+1];var p=l[w*3+2];var O=new Ammo.btVector3(e[A*3],e[A*3+1],e[A*3+2]);var L=new Ammo.btVector3(e[d*3],e[d*3+1],e[d*3+2]);var g=new Ammo.btVector3(e[p*3],e[p*3+1],e[p*3+2]);r.addTriangle(O,L,g)}let N=new Ammo.btBvhTriangleMeshShape(r,true,true);N.setMargin(.2);let Y=new Ammo.btVector3(0,0,0);let y=new Ammo.btTransform;y.setIdentity();y.setOrigin(new Ammo.btVector3(s.x,s.y,s.z));let b=t.rotationQuaternion||new BABYLON.Quaternion.RotationYawPitchRoll(t.rotation.x,t.rotation.y,t.rotation.z);y.setRotation(new Ammo.btQuaternion(b.x,b.y,b.z,b.w));let v=new Ammo.btDefaultMotionState(y);let _=new Ammo.btRigidBodyConstructionInfo(0,v,N,Y);let k=new Ammo.btRigidBody(_);k.setFriction(1e3);k.setDamping(100,100);t.metadata={physicsBody:null,tag:"ground",_callback:null,collisionCount:0,_sound:null,_soundExplosion:null};k.objectMesh=t;t.metadata.physicsBody=k;t.metadata.physicsBody.objectMesh=t;window.ammoPlugin.world.addRigidBody(k);this.meshes.push(t)}js(){BABYLON.SceneLoader.ImportMeshAsync(null,"./models/","table-wooden-low7.glb",scene).then((t=>{this.Ws=t;let s=this.Ws.meshes[1]._boundingInfo.boundingBox.maximum;let e=this.Ws.meshes[1]._boundingInfo.boundingBox.minimum;let i=Math.abs(s.y)+Math.abs(e.y);let h=Math.abs(s.x)+Math.abs(e.x);let n=Math.abs(s.z)+Math.abs(e.z);this.Us(this.Ws.meshes,"mesa",{x:5,y:0,z:5},20);BABYLON.SceneLoader.ImportMeshAsync(null,"./models/","Grenade-soviet-low.glb",scene).then((t=>{this.Zs=t;this.Ks.attachToMesh(this.Zs.meshes[0]);this.Zs.meshes[0].id="_rootgrenade_";this.Zs.meshes[0].name="_rootgrenade_";this.Zs.meshes[1].id="_shapegrenade_";this.Zs.meshes[1].name="_shapegrenade_";this.Vs(this.Zs.meshes[1],"grenadeShape");for(let t in this.Zs.meshes){this.Zs.meshes[t].rotationQuaternion=null;if(t==1){}}setTimeout((function(t){}),3e3,this);let s=this.Ws.meshes[0].position;this.Zs.meshes[0].position.copyFrom(new BABYLON.Vector3(s.x,s.y+1.3,s.z));this.Ws.meshes[0].addChild(this.Zs.meshes[0]);this.Ws.meshes[0].addChild(this.Zs.meshes[1]);setTimeout((function(t){}),2e4,this)}))}))}Hs(){BABYLON.SceneLoader.ImportMeshAsync(null,"./models/","stone-wall1.glb",scene).then((t=>{this.Js=t;this.Js.meshes[0].isVisible=false;this.Js.meshes[0].position.copyFrom(new BABYLON.Vector3(0,-1,0));this.Vs(this.Js.meshes[1],"brickshape");let s=this.Js.meshes[1]._boundingInfo.boundingBox.maximum;let e=this.Js.meshes[1]._boundingInfo.boundingBox.minimum;let i=Math.abs(s.y)+Math.abs(e.y);let h=Math.abs(s.x)+Math.abs(e.x);let n=Math.abs(s.z)+Math.abs(e.z);let l=110;let o=110;let a=1e20;let r=new Ammo.btBoxShape(new Ammo.btVector3(h/2,i,n/2));this.Qs(this.Js.meshes,"wall",{x:10,y:0,z:-10},r,0,{qs:1,direction:{x:1,y:1,z:1},Xs:[5e6,5e5]})}));this.js();let t="barrel-mixed-low2.glb";BABYLON.SceneLoader.ImportMeshAsync(null,"./models/",t,scene).then((t=>{this.$s=t;console.log("BARREL");console.log(this.$s);this.Us(this.$s.meshes,"barrel",{x:0,y:0,z:15},8);let s=BABYLON.MeshBuilder.CreateSphere("explosionzone",{diameter:.1});s.isVisible=false;this.$s.meshes[1].addChild(s);s.position.copyFrom(new BABYLON.Vector3(0,this.$s.meshes[1]._boundingInfo.boundingSphere.radius+1,0))}));this.te()}se(t,s){this.ks.animations=[this.ee({property:"position",from:this.ks.position,to:t,_callback:s})]}ie(t){const s=t%(2*Math.PI);return s<0?s+BABYLON.Tools.ToRadians(360):s}he(t){}ee({property:t,from:s,to:e,_callback:i}){const h=new BABYLON.CubicEase;const n=new BABYLON.Node("node",scene);const l=BABYLON.Animation.CreateAndStartAnimation("at4",this.ks,"position",300,30,s,e,0,h,(function(t){i()}));l.ne=true;return l}te(){const t=new Ammo.btTransform;t.setIdentity();this.O=BABYLON.MeshBuilder.CreateBox("outer",{width:.6,le:.6,height:2,updatable:true},scene);let s=this.O.position.x;let e=this.O.position.y;let i=this.O.position.z;this.O.metadata={tag:"",objectMesh:null};this.O.metadata.tag="player";this.O.position.copyFrom(new BABYLON.Vector3(0,2,0));let h=new BABYLON.Vector3(this.O.position.x,this.O.position.y-.5,this.O.position.z-3);this.ks.position.copyFrom(h);this.ks.setTarget(new BABYLON.Vector3(s,e,i));this.O.isVisible=false;this.O.isPickable=false;this.O.checkCollisions=true;this.O.physicsImpostor=new BABYLON.PhysicsImpostor(this.O,BABYLON.PhysicsImpostor.BoxImpostor,{mass:80});setTimeout((function(t){console.log("PLAYER PHYDICS BODY");console.log(t.O.physicsImpostor.physicsBody);t.O.physicsImpostor.physicsBody.setDamping(0,0);t.O.physicsImpostor.physicsBody.setFriction(1e3);t.O.physicsImpostor.physicsBody.objectMesh=t.O;t.U.copyFrom(t.O.position);t.Z.copyFrom(t.O.rotation);t.K=true;t.ks.parent=t.O}),5e3,this);BABYLON.SceneLoader.ImportMeshAsync(null,"./models/","wolf-game.glb",scene).then((t=>{this.oe=t;this.ae=BABYLON.MeshBuilder.CreateBox("animalGround",{width:.5,le:1.5,height:1,updatable:true},scene);let s=new BABYLON.StandardMaterial("animalGroundColliderMaterial",scene);this.ae.material=s;this.ae.material.re=true;this.ae.metadata={tag:"",objectMesh:null};this.ae.metadata.tag="animalGround";this.ae.position.copyFrom(new BABYLON.Vector3(-1.9,1,1.9));this.ae.isVisible=true;this.ae.isPickable=false;this.ae.checkCollisions=true;this.oe.meshes[0].parent=this.ae;this.oe.meshes[0].position.copyFrom(new BABYLON.Vector3(0,-.5,-.5));this.ae.physicsImpostor=new BABYLON.PhysicsImpostor(this.ae,BABYLON.PhysicsImpostor.BoxImpostor,{mass:.1});for(let t in this.oe.meshes){}console.log("ANIMAL ");console.log(this.oe);this.me=["idle0","run"];this.st["idle0"]=this.oe.animationGroups[3];this.st["run"]=this.oe.animationGroups[0];for(let t in this.me){let s=this.me[t];this.st[s].setWeightForAllAnimatables(0);this.st[s].play(true);this.st[s].normalize()}this.st["idle0"].setWeightForAllAnimatables(1)}));BABYLON.SceneLoader.ImportMeshAsync(null,"./models/","v6.glb",scene).then((t=>{console.log("GEORGE");console.log(t);this.ue=t;this.St=t.meshes;this.ce.attachToMesh(this.ue.meshes[0]);this.fe.attachToMesh(this.ue.meshes[0]);this.ft=t.transformNodes[63];let s=t.animationGroups;scene.Be=()=>this.O.absolutePosition;let e=t.skeletons[0];for(let t=0;t<5;t++){for(let s=0;s<5;s++){for(let e in this.ue.meshes){let i=this.ue.meshes[e].clone();i.position.x=t;i.position.z=s}}}this.Pt=e.bones[53];for(let t in e.bones){if(e.bones[t].name=="Grenade_socket_2"){console.log("BACKBONE ID"+t)}}this.we=e.bones[56];this.m.push(e.bones[69]);this.m.push(e.bones[70]);this.m.push(e.bones[71]);this.m.push(e.bones[72]);this.u.push(0);this.u.push(0);this.u.push(0);this.u.push(0);console.log("SOCKET STATES");console.log(this.u);let i=new BABYLON.Vector3(0,0,0);i.add(this.O.forward);i.scaleInPlace(this.Qt+this.Xt);this.rs.copyFrom(i);this.Ae();this.ht=["idle0","crosshair","crosshairwalk","jump","walk","run","prethrow","throw","prethrowpose","pickitem","pickitembackpack"];this.animations["idle0"]=this.ue.animationGroups[4];this.animations["crosshair"]=this.ue.animationGroups[3];this.animations["crosshairwalk"]=this.ue.animationGroups[11];this.animations["jump"]=this.ue.animationGroups[6];this.animations["walk"]=this.ue.animationGroups[10];this.animations["run"]=this.ue.animationGroups[9];this.animations["prethrow"]=this.ue.animationGroups[1];this.animations["prethrowpose"]=this.ue.animationGroups[2];this.animations["pickitem"]=this.ue.animationGroups[7];this.animations["pickitem"].de=.5;this.animations["pickitembackpack"]=this.ue.animationGroups[8];this.animations["throw"]=this.ue.animationGroups[0];this.animations["pe"]=this.ue.animationGroups[12];let h=0;for(let t in this.ht){let s=this.ht[t];this.animations[s].setWeightForAllAnimatables(0);this.animations[s].play(true);this.animations[s].normalize();h++}this.animations["idle0"].setWeightForAllAnimatables(1);this.lt=this.animations["idle0"];this.ot=this.animations["idle0"];this.et="idle0";this.it="idle0";this.ds=true;const n=t.meshes[0];const l=n;l.parent=this.O;l.position=new BABYLON.Vector3(0,-1,0);l.isPickable=false;l.getChildMeshes().forEach((t=>{t.isPickable=false}))}));this.Oe();this.Le()}ge(t,s){t.bakeCurrentTransformIntoVertices();let e=t.getVerticesData(BABYLON.VertexBuffer.PositionKind);let i=1;let h=1;let n="PHY_FLOAT";let l=false;var o=new Ammo.btHeightfieldTerrainShape(terrainWidth,terrainDepth,e,i,terrainMinHeight,terrainMaxHeight,h,n,l);let a=new Ammo.btTransform;a.setIdentity();a.setOrigin(new Ammo.btVector3(0,(terrainMinHeight+terrainMaxHeight)/2,0));let r=0;let m=new Ammo.btVector3(0,0,0);let u=new Ammo.btDefaultMotionState(a);let c=new Ammo.btRigidBody(new Ammo.btRigidBodyConstructionInfo(r,u,o,m));window.ammoPluginworld.addRigidBody(c);this.Hs()}Ae(){BABYLON.SceneLoader.ImportMeshAsync(null,"./models/","chaleco2.glb",scene).then((t=>{this.Ne=t;console.log("CHALECO");console.log(t);this.tt["idle0"]=this.Ne.animationGroups[4];this.tt["crosshair"]=this.Ne.animationGroups[3];this.tt["crosshairwalk"]=this.Ne.animationGroups[11];this.tt["jump"]=this.Ne.animationGroups[5];this.tt["walk"]=this.Ne.animationGroups[10];this.tt["run"]=this.Ne.animationGroups[9];this.tt["prethrow"]=this.Ne.animationGroups[1];this.tt["prethrowpose"]=this.Ne.animationGroups[2];this.tt["pickitem"]=this.Ne.animationGroups[6];this.tt["pickitem"].de=.5;this.tt["pickitembackpack"]=this.Ne.animationGroups[7];this.tt["throw"]=this.Ne.animationGroups[0];this.tt["pe"]=this.Ne.animationGroups[12];for(let t in this.ht){let s=this.ht[t];this.animations[s].reset();this.tt[s].reset();this.tt[s].setWeightForAllAnimatables(0);this.tt[s].play(true);this.tt[s].normalize()}this.tt["idle0"].setWeightForAllAnimatables(1);this.Ne.meshes[0].parent=this.O;this.Ne.meshes[0].position=new BABYLON.Vector3(0,-1,0);this.I=true}));BABYLON.SceneLoader.ImportMeshAsync(null,"./models/","sks3.glb",scene).then((t=>{let s=t;this.Vt=t.transformNodes[0];this.Ct=t.meshes;this.ls.attachToMesh(s.meshes[0]);this.Ye.attachToMesh(s.meshes[0]);let e=this.St[0];let i=-.1;let h=.9;let n=0;let l=new BABYLON.Vector3(this.Ft.x,this.Ft.y,this.Ft.z);let o=new BABYLON.Quaternion(this.Et.x,this.Et.y,this.Et.z,1);this.nt=true;for(let t in this.Ct){this.Ct[t].attachToBone(this.Pt,e);this.Ct[t].position.copyFrom(l);this.Ct[t].rotation.copyFrom(o)}this.ye();setTimeout((function(t){engine.hideLoadingUI();t.Tt=true}),5e3,this)}))}xs(){this.Ks=new BABYLON.Sound("soundGrenadePick","sounds/grenade-pick.ogg",scene,null,{loop:false,autoplay:false,volume:.1});this.be=new BABYLON.Sound("soundGrenadeCollision","sounds/grenade-collision.ogg",scene,null,{loop:false,autoplay:false,volume:.1});this.ls=new BABYLON.Sound("soundZoom","sounds/zoom-add.ogg",scene,null,{loop:false,autoplay:true,volume:1});this.ce=new BABYLON.Sound("soundWalk","sounds/walking.ogg",scene,null,{loop:true,autoplay:false,volume:.5});console.log("SOUND OBKE");console.log(this.ce);this.fe=new BABYLON.Sound("soundRun","sounds/running.ogg",scene,null,{loop:true,autoplay:false,volume:.5});this.Ye=new BABYLON.Sound("soundPickGun","sounds/pick-gun.wav",scene,null,{loop:false,autoplay:false,volume:.5});document.getElementById("menuMain").style.display="block";this.os=new BABYLON.Sound("soundFireBurn","sounds/fire-burn.wav",scene,null,{loop:true,autoplay:false,volume:.1});this.ve=new BABYLON.Sound("soundGunShot","sounds/gunshot-short.ogg",scene,null,{loop:false,autoplay:false,volume:.8});this._e=new BABYLON.Sound("soundExplosion","sounds/boom.wav",scene,null,{loop:false,autoplay:false,volume:1});BABYLON.Engine.audioEngine.setGlobalVolume(1)}ke(){if(this.Ns||!this.ns){return}if(this.ve.isPlaying){this.ve.stop();this.ve.play()}else{this.ve.play()}this.xe()}async Me(){this.i=scene.getEngine().getDeltaTime()/1e3;let t=Date.now();if(t>this.N+1e3||this.rt){this.O.physicsImpostor.physicsBody.setGravity(new Ammo.btVector3(0,-9.81,0));this.O.physicsImpostor.physicsBody.applyGravity();this.ct=false}if(this.q["w"]){let t=this.O.forward;let s=new BABYLON.Vector3(t.x/this.wt,t.y/this.wt,t.z/this.wt);this.O.moveWithCollisions(s);this.U.copyFrom(new BABYLON.Vector3(this.O.position.x,this.O.position.y,this.O.position.z));this.Z.copyFrom(this.O.rotation)}else{if(this.K){this.O.physicsImpostor.physicsBody.setAngularVelocity(new Ammo.btVector3(0,0,0));if(!this.rt){this.O.physicsImpostor.physicsBody.setLinearVelocity(new Ammo.btVector3(0,0,0))}this.O.physicsImpostor.physicsBody.clearForces()}}const s=this.O.rotationQuaternion.toEulerAngles();let e=0;let i=s.y;let h=0;let n=BABYLON.Quaternion.FromEulerAngles(e,i,h);this.O.rotationQuaternion=n;if(this.ae!=undefined){const t=this.ae.rotationQuaternion.toEulerAngles();let s=0;let e=t.y;let i=0;let h=BABYLON.Quaternion.FromEulerAngles(s,e,i);this.ae.rotationQuaternion=h}if(this.kt){if(this.hs){return}else{if(!this.ns){if(this.Ns){return}this.k=true;await this.Pe(this.i);return}}}else{this.k=false;if(this.ns&&!this.hs){this.Re()}}}Re(){if(this.es){return}if(this.hs){return}if(this.ns){this.hs=true}if(this.$t){return}this.se(this.ss,this.Ce.bind(this));this.ts=null;this.ns=false;document.getElementById("crosshair").style.display="none"}async Pe(t){var s=new BABYLON.Vector3;s.copyFrom(this.ks.position);s.x-=.5;s.z+=.1;if(this.es){return}else{this.ss.copyFrom(this.ks.position)}if(this.hs){return}if(!this.ns){this.hs=true}if(this.ts==null){this.ts=this.ks.rotation;if(this.$t){return}if(this.es){return}this.se(new BABYLON.Vector3(this.ks.position.x+.5,this.ks.position.y,this.ks.position.z+.5),this.Se.bind(this))}document.getElementById("crosshair").style.display="block"}async Te(){let t=Date.now();if(t-this.ps>12e3){let s=Math.floor(Math.random()*1);this.ps=t;this.Os="idle"+s;return"idle"+s}else{return this.Os}}De(){this.W=false;BABYLON.SceneLoader.ImportMeshAsync(null,"./models/","Grenade-soviet-low.glb",scene).then((t=>{let s=t;let e=new BABYLON.Vector3(this.O.position.x,2,this.O.position.z);s.meshes[0].position.copyFrom(e);for(let t in s.meshes){s.meshes[t].rotationQuaternion=null}var i=scene.pick(window.innerWidth/2,window.innerHeight/2);let h=i.ray.direction;for(let t in this.Ss.meshes){scene.removeMesh(this.Ss.meshes[t])}this.Qs(s.meshes,"grenadethrow",{x:this.O.position.x,y:this.O.position.y+2,z:this.O.position.z},this.grenadeShape,.8,{qs:28,direction:{x:h.x,y:h.y,z:h.z},Xs:[.5,.5]})}))}Ge(){let t=new BABYLON.Vector3(this.Ft.x,this.Ft.y,this.Ft.z);let s=new BABYLON.Quaternion(this.Et.x,this.Et.y,this.Et.z,1);for(let e in this.Ct){this.Ct[e].position.copyFrom(t);this.Ct[e].rotation.copyFrom(s)}}Fe(){let t=new BABYLON.Vector3(this.zt.x,this.zt.y,this.zt.z);let s=new BABYLON.Quaternion(this.Ht.x,this.Ht.y,this.Ht.z,1);for(let e in this.Ct){this.Ct[e].position.copyFrom(t);this.Ct[e].rotation.copyFrom(s)}}Ee(){let t=new BABYLON.Vector3(this.jt.x,this.jt.y,this.jt.z);let s=new BABYLON.Quaternion(this.Wt.x,this.Wt.y,this.Wt.z,1);for(let e in this.Ct){this.Ct[e].attachToBone(this.we,this.St[0]);this.Ct[e].position.copyFrom(t);this.Ct[e].rotation.copyFrom(s)}}ze(){let t=new BABYLON.Vector3(this.Ft.x,this.Ft.y,this.Ft.z);let s=new BABYLON.Quaternion(this.Et.x,this.Et.y,this.Et.z,1);for(let e in this.Ct){this.Ct[e].attachToBone(this.Pt,this.St[0]);this.Ct[e].position.copyFrom(t);this.Ct[e].rotation.copyFrom(s)}}async He(){if(!this.Tt)return;if(!this.q["shift"]&&!this.ut&&!this.rt&&this.q["w"]){if(this.kt){this.ot=this.animations["crosshairwalk"];this.et="crosshairwalk";this.wt=this.dt}else{this.ot=this.animations["walk"];this.wt=this.dt;this.et="walk"}}else if(this.q["shift"]&&this.q["w"]&&!this.ut&&!this.rt){if(!this.kt){this.ot=this.animations["run"];this.wt=this.At;this.et="run"}else{this.ot=this.animations["crosshairwalk"];this.et="crosshairwalk";this.wt=this.dt;if(this.fe.isPlaying){this.fe.stop();if(!this.ce.isPlaying){this.ce.play(true)}}else{if(!this.ce.isPlaying){this.ce.play(true)}}}}else if(this.rt&&!this.ut&&!this.q["shift"]){this.ot=this.animations["jump"];this.et="jump";if(this.ce.isPlaying){this.ce.stop()}if(this.fe.isPlaying){this.fe.stop()}}else if(!this.ut&&this.Ie){let t=await this.Te();this.ot=this.animations[t];this.wt=this.dt;this.et=t;if(this.ce.isPlaying){this.ce.stop()}if(this.fe.isPlaying){this.fe.stop()}}else if(this.ut){this.ot=this.animations["jump"];this.et="jump";this.wt=this.dt;if(this.ce.isPlaying){this.ce.stop()}if(this.fe.isPlaying){this.fe.stop()}}else{if(this.ce.isPlaying){this.ce.stop()}if(this.fe.isPlaying){this.fe.stop()}if(this.k||this.es){this.ot=this.animations["crosshair"];this.et="crosshair"}else{if(this.W&&this.Y){if(!this._){this.V=Date.now();this._=true;this.et="prethrow";this.animations["prethrow"].restart();this.animations["prethrow"].stop();this.animations["prethrow"].start(true);this.tt["prethrow"].restart();this.tt["prethrow"].stop();this.tt["prethrow"].start(true);this.ot=this.animations["prethrow"];this.wt=this.dt}else{let t=Date.now();if(t-this.V>1600){if(this.ot.isPlaying){this.Bt=true;document.getElementById("crosshair").style.display="block";for(let t in this.animations){this.animations[t].setWeightForAllAnimatables(0);this.tt[t].setWeightForAllAnimatables(0)}this.ot=this.animations["prethrowpose"];this.et="prethrowpose";this.ot.setWeightForAllAnimatables(1);this.tt[this.et].setWeightForAllAnimatables(1);this.bt=false;this.lt=this.ot;this.it=this.et;this.vt=0;this._t=1}}else{this.ot=this.animations["prethrow"];this.et="prethrow"}}}else{if(this.Bt){if(!this.R){this.j=Date.now();this.R=true;this.De();this.animations["throw"].restart();this.animations["throw"].stop();this.animations["throw"].start(true);this.tt["throw"].restart();this.tt["throw"].stop();this.tt["throw"].start(true);this.et="throw";this.ot=this.animations["throw"];this.wt=this.dt}else{let t=Date.now();if(t-this.j>1600){if(this.ot.isPlaying){this.Bt=false;this._=false;this.R=false;document.getElementById("crosshair").style.display="none";for(let t in this.animations){this.animations[t].setWeightForAllAnimatables(0);this.tt[t].setWeightForAllAnimatables(0)}this.ot=this.animations["idle0"];this.et="idle0";this.ot.setWeightForAllAnimatables(1);this.tt[this.et].setWeightForAllAnimatables(1);this.bt=false;this.lt=this.ot;this.it=this.et;this.vt=0;this._t=1}}else{this.et="throw";this.ot=this.animations["throw"];this.wt=this.dt}}}else{if(this.q["f"]&&this.p){if(!this.us){if(this.W)return;this.Cs();this.cs=Date.now();this.us=true;this.animations["pickitem"].stop();this.animations["pickitem"].restart();this.animations["pickitem"].start(true);this.tt["pickitem"].stop();this.tt["pickitem"].restart();this.tt["pickitem"].start(true);this.et="pickitem";this.ot=this.animations["pickitem"];this.wt=this.dt}else{let t=Date.now();if(t-this.cs>900){if(this.ot.isPlaying){this.Ks.play();this.us=false;for(let t in this.animations){this.animations[t].setWeightForAllAnimatables(0);this.tt[t].setWeightForAllAnimatables(0)}this.ot=this.animations["idle0"];this.et="idle0";this.ot.setWeightForAllAnimatables(1);this.tt[this.et].setWeightForAllAnimatables(1);this.bt=false;this.lt=this.ot;this.it=this.et;this.vt=0;this._t=1;this.q["f"]=false}}else{this.ot=this.animations["pickitem"];this.et="pickitem"}}}else if(this.q["f"]&&!this.p){if(!this.P){this.M=Date.now();this.P=true;this.Ye.play(true);this.animations["pickitembackpack"].stop();this.animations["pickitembackpack"].restart();this.animations["pickitembackpack"].start(true);this.tt["pickitembackpack"].stop();this.tt["pickitembackpack"].restart();this.tt["pickitembackpack"].start(true);this.et="pickitembackpack";this.ot=this.animations["pickitembackpack"];this.wt=this.dt}else{let t=Date.now();if(t-this.M>500){if(this.ot.isPlaying){this.bt=false;this.P=false;if(!this.Ns){this.Ee();this.Ns=true}else{this.ze();this.Ns=false}for(let t in this.animations){this.tt[t].setWeightForAllAnimatables(0);this.animations[t].setWeightForAllAnimatables(0)}this.ot=this.animations["idle0"];this.et="idle0";this.ot.setWeightForAllAnimatables(1);this.tt[this.et].setWeightForAllAnimatables(1);this.vt=0;this._t=1;this.ot.syncAllAnimationsWith(null);this.tt[this.et].syncAllAnimationsWith(null);this.lt.syncAllAnimationsWith(this.ot.animatables[0]);this.tt[this.it].syncAllAnimationsWith(this.tt[this.et].animatables[0]);this.ot.setWeightForAllAnimatables(1);this.tt[this.et].setWeightForAllAnimatables(1);this.lt.setWeightForAllAnimatables(0);this.tt[this.it].setWeightForAllAnimatables(0);this.ot.normalize();this.tt[this.et].normalize();this.lt=this.ot;this.it=this.et;this.q["f"]=false}}else{}}}else{if(this.lt!=undefined){}if(this.ce.isPlaying){this.ce.stop()}if(this.fe.isPlaying){this.fe.stop()}let t=await this.Te();this.et=t;this.ot=this.animations[t];this.wt=this.dt}}}}}if(this.ot!=null&&this.lt!==this.ot){this.bt=true}}je(t,s){let e=1;let i=0;if(s.We){}else{}for(let h=0;h<=1;h+=.08){if(h<=.9){}i+=.002;e-=.002;s.setWeightForAllAnimatables(i);t.setWeightForAllAnimatables(e)}}Ue(){for(let s=0;s<this.Bs.length;s++){let e=this.Bs[s];if(e.intersectsMesh(scene.getMeshByName("platform1"))||e.intersectsMesh(scene.getMeshByName("Cylinder"))||e.intersectsMesh(scene.getMeshByName("ground"))){let i=e.metadata;let h=i.sourceMesh;let n=i.position;let l=i.normal;let o=0;let a=true;var t=new BABYLON.Vector3(.25,.25,.25);let r=BABYLON.MeshBuilder.CreateDecal("decal",h,{position:n,normal:l,angle:o,size:t,cullBackFaces:a,localMode:true});r.material=this.ws;this.Ze(h);scene.removeMesh(e);this.os.attachToMesh(h);this.os.play(true);this.Bs=this.Bs.filter(((t,e)=>t!=s))}}}ye(){this.Ke=new Ammo.ConcreteContactResultCallback;this.Ke.addSingleResult=function(t,s,e,i,h,n,l){let o=Ammo.wrapPointer(t,Ammo.btManifoldPoint);const a=o.getDistance();if(a>0){return}let r=Ammo.wrapPointer(s,Ammo.btCollisionObjectWrapper);let m=Ammo.castObject(r.getCollisionObject(),Ammo.btRigidBody);let u=Ammo.wrapPointer(h,Ammo.btCollisionObjectWrapper);let c=Ammo.castObject(u.getCollisionObject(),Ammo.btRigidBody);let f=m.objectMesh;let B=c.objectMesh;if(f!=undefined&&B!=undefined){let t=B.metadata.tag;let s=f.metadata.tag;if(s=="player"){if(t!="ground"){}if(!this.ct){if(this.rt){this.rt=false;this.ut=false}this.ct=true;this.O.physicsImpostor.physicsBody.setAngularVelocity(new Ammo.btVector3(0,0,0));this.O.physicsImpostor.physicsBody.setLinearVelocity(new Ammo.btVector3(0,0,0));this.O.physicsImpostor.physicsBody.clearForces();this.O.physicsImpostor.physicsBody.setGravity(new Ammo.btVector3(0,-.01,0));this.O.physicsImpostor.physicsBody.applyGravity()}this.N=Date.now()}else if(t=="player"){if(s!="ground"){}if(!this.ct){if(this.rt){this.rt=false;this.ut=false}this.ct=true;this.O.physicsImpostor.physicsBody.setAngularVelocity(new Ammo.btVector3(0,0,0));this.O.physicsImpostor.physicsBody.setLinearVelocity(new Ammo.btVector3(0,0,0));this.O.physicsImpostor.physicsBody.clearForces();this.O.physicsImpostor.physicsBody.setGravity(new Ammo.btVector3(0,-.01,0));this.O.physicsImpostor.physicsBody.applyGravity();console.log("PLAYER ON GROUND")}this.N=Date.now()}if(s=="grenadethrow"){if(t=="ground"||t=="wall"){let t=f.metadata["_sound"];if(f.metadata.collisionCount<3){f.metadata["collisionCount"]+=1;if(f.metadata["_sound"].isPlaying){t.stop();t.play()}else{t.play()}}}}else if(t=="grenadethrow"){if(s=="ground"||s=="wall"){let t=B.metadata["_sound"];if(B.metadata.collisionCount<3){B.metadata["collisionCount"]+=1;if(B.metadata["_sound"].isPlaying){t.stop();t.play()}else{t.play()}}}}}let w,A,d}.bind(this)}Ve(){if(this.Tt){if(this.$.length>0){for(let t in this.$){window.ammoPlugin.world.contactTest(this.$[t].metadata.physicsBody,this.Ke)}}window.ammoPlugin.world.contactTest(this.O.physicsImpostor.physicsBody,this.Ke);if(this.Ws!=undefined&&this.O!=undefined){let t=this.Ws.meshes[0].position;let s=this.O.position;let e=new BABYLON.Vector3(t.x,t.y,t.z);let i=new BABYLON.Vector3(s.x,s.y,s.z);let h=BABYLON.Vector3.Distance(e,i);if(h<2){if(this.L){return}else{if(this.Zs!=undefined){this.p=true;this.Nt.blurHorizontalSize=0;this.Nt.blurVerticalSize=0;this.Nt.addMesh(this.Zs.meshes[1],BABYLON.Color3.Green());this.L=true}}}else{if(this.Zs!=undefined){this.p=false;this.Nt.removeMesh(this.Zs.meshes[1]);this.L=false}}}}}Le(){scene.registerBeforeRender((()=>{this.Me();this.Je();this.He();this.Ve();this.Ps()}))}Je(){if(this.bt){this.vt+=.5;this._t-=.5;if(this.lt.name=="Rig|Rig|jump0"&&!this.ut){this.lt.setWeightForAllAnimatables(0);this.ot.setWeightForAllAnimatables(1);if(this.I){this.tt[this.it].setWeightForAllAnimatables(0);this.tt[this.et].setWeightForAllAnimatables(1)}this.bt=false;this.lt=this.ot;this.it=this.et;this.vt=0;this._t=1}else{if(this.et==this.it&&this.ot.name!="Rig|Rig|Prethrow"&&this.ot.name!="Rig|Rig|Throw"&&this.ot.name!="Rig|Rig|PickItem"&&this.ot.name!="Rig|Rig|PickBackpack"){if(this.I){this.tt[this.et].setWeightForAllAnimatables(1)}this.animations[this.et].setWeightForAllAnimatables(1);for(let t=0;t<this.ht.length;t++){if(this.et!=this.ht[t]){this.animations[this.ht[t]].setWeightForAllAnimatables(0);if(this.I){this.tt[this.ht[t]].setWeightForAllAnimatables(0)}}if(t==this.ht.length-1){this.lt=this.ot;this.it=this.et;this.vt=0;this._t=1}}return}this.ot.syncAllAnimationsWith(null);this.lt.syncAllAnimationsWith(this.ot.animatables[0]);this.ot.setWeightForAllAnimatables(this.vt);this.lt.setWeightForAllAnimatables(this._t);this.ot.normalize();if(this.I){let t=this.tt[this.et];let s=this.tt[this.it];t.syncAllAnimationsWith(null);s.syncAllAnimationsWith(t.animatables[0]);t.setWeightForAllAnimatables(this.vt);s.setWeightForAllAnimatables(this._t)}if(this.vt>=1){this.bt=false;this.vt=1;this._t=0;if(this.I){this.tt[this.et].setWeightForAllAnimatables(this.vt);this.tt[this.it].setWeightForAllAnimatables(this._t)}this.ot.setWeightForAllAnimatables(this.vt);this.lt.setWeightForAllAnimatables(this._t);for(let t=0;t<this.ht.length;t++){if(this.et!=this.ht[t]){this.animations[this.ht[t]].setWeightForAllAnimatables(0);if(this.I){this.tt[this.ht[t]].setWeightForAllAnimatables(0)}}if(t==this.ht.length-1){this.lt=this.ot;this.it=this.et;this.vt=0;this._t=1}}}}}else{if(this.ot!=undefined){this.ot.normalize()}}}async Oe(){document.getElementById("gameStart").onclick=function(){document.body.requestPointerLock()};document.addEventListener("pointerlockchange",this.Qe,false);document.addEventListener("pointermove",this.qe.bind(this));document.addEventListener("keydown",this.Xe.bind(this));document.addEventListener("keyup",this.$e.bind(this));document.addEventListener("mousedown",this.ti.bind(this));document.addEventListener("mouseup",this.si.bind(this));document.addEventListener("wheel",this.ei.bind(this))}async Se(){let t=new BABYLON.Vector3(this.Ut.x,this.Ut.y,this.Ut.z);let s=new BABYLON.Quaternion(this.Zt.x,this.Zt.y,this.Zt.z,1);for(let e in this.Ct){this.Ct[e].position.copyFrom(t);this.Ct[e].rotation.copyFrom(s)}this.hs=false;this.ns=true;if(this.es){let t=new BABYLON.Vector3(0,0,0);t.add(this.O.forward);var e=scene.pick(window.innerWidth/2,window.innerHeight/2);let s=this.Qt+this.Xt/10;let i=new BABYLON.Vector3(t.x,this.Vt.absolutePosition.y,t.z+s);let h=e.ray.origin._x+e.ray.direction._x+s;let n=e.ray.origin._z+e.ray.direction._z+s;this.rs.copyFrom(i);this.ks.position.copyFrom(i)}}Ce(){this.hs=false;this.ns=false;let t=new BABYLON.Vector3(this.Ft.x,this.Ft.y,this.Ft.z);let s=new BABYLON.Quaternion(this.Et.x,this.Et.y,this.Et.z,1);for(let e in this.Ct){this.Ct[e].position.copyFrom(t);this.Ct[e].rotation.copyFrom(s)}}ei(t){if(this.es){var s=scene.pick(window.innerWidth/2,window.innerHeight/2);if(t.deltaY>0){if(this.Qt==1){return}if(!this.ls.isPlaying){this.ls.play()}if(this.Jt<1.1){this.Jt+=.1}else{this.Jt=1.1}this.Qt--;let t=(this.Qt+this.Xt)/10;let e=(this.ks.position.x+s.ray.direction.x)*-t;let i=(this.ks.position.z+s.ray.direction.z)*-t;let h=new BABYLON.Vector3(this.ks.position.x,this.ks.position.y,this.ks.position.z-t);if(h.z<this.Vt.absolutePosition.z){let t=new BABYLON.Vector3(h.x,this.Vt.absolutePosition.y,h.z);this.Qt=1}else{this.ks.position.copyFrom(h)}}else{if(this.Qt==this.qt){return}if(!this.ls.isPlaying){this.ls.play()}if(this.Jt>.1){this.Jt-=.1}else{this.Jt=.1}this.Qt++;let t=(this.Qt+this.Xt)/10;let e=s.ray.origin.x+s.ray.direction.x+t;let i=s.ray.origin.z+s.ray.direction.z+t;let h=new BABYLON.Vector3(this.ks.position.x,this.ks.position.y,this.ks.position.z+t);this.ks.position.copyFrom(h)}}}si(t){if(t.button==2){let t=Date.now();if(this.es){this.es=false;document.getElementById("sniper-crosshair-box").style.display="none";this.Jt=1.1;this.kt=false;return}if((t-this.xt)/60<11&&!this.es){this.es=true;this.ns=true;this.hs=false;this.Jt=.8;var s=new BABYLON.Vector3;s.add(this.O.forward);s.scaleInPlace(2);document.getElementById("sniper-crosshair-box").style.display="block"}this.kt=false}else if(t.button==0){this.Y=false}}ti(t){var s;t=t||window.event;if("which"in t)s=t.button==2;else if("button"in e)s=t.button==2;if(s){this.kt=true;this.Jt=.8;this.xt=Date.now()}else if(t.button==0){this.Y=true;if(this.Mt==null){this.Mt=Date.now();this.ke()}else{var i=Date.now();if(i>this.Mt+0){this.ke();this.Mt=i}else{}}}}ii(){}Qe(t){if(document.pointerLockElement==null){document.getElementById("menuMain").style.display="block"}else{document.getElementById("menuMain").style.display="none"}}$e(t){switch(t.which){case 16:if(this.fe.isPlaying){this.fe.stop();if(this.q["w"]){this.ce.play(false)}}this.q["shift"]=false;if(!this.Ns){this.Ge()}break;case 70:break;case 87:if(this.ce.isPlaying){this.ce.stop()}if(this.fe.isPlaying){this.fe.stop()}this.q["w"]=false;break;case 32:this.q["X"]=false;break;default:break}}Xe(t){switch(t.which){case 16:this.q["shift"]=true;if(this.q["w"]){if(!this.Ns){this.Fe()}if(this.ce.isPlaying){this.ce.stop()}if(!this.fe.isPlaying){console.log("SWITCHING RUN");this.fe.play(false)}}break;case 70:this.q["f"]=true;break;case 87:if(!this.ce.isPlaying){this.ce.play(false)}this.q["w"]=true;break;case 32:if(!this.rt){this.jump();this.rt=true;this.ut=true}this.q["X"]=true;break;default:break}}jump(){this.ct=false;this.animations["jump"].reset();this.tt["jump"].reset();let t=this.O.physicsImpostor.getLinearVelocity();console.log(t);let s=this.O.forward;let e=new BABYLON.Vector3(s.x/this.wt,s.y/this.wt,s.z/this.wt);this.O.moveWithCollisions(e);let i=0;if(this.q["w"]){i=6}else{i=4}this.O.physicsImpostor.setLinearVelocity(new BABYLON.Vector3(this.O.forward.x+t._x,i,this.O.forward.z+t._z))}xe(){let t=this.Vt.absolutePosition;var s=scene.pick(window.innerWidth/2,window.innerHeight/2);let e=s.ray.origin;let i=s.ray.direction;let h;h=new BABYLON.Vector3(t.x,t.y,t.z);let n=new BABYLON.Vector3(i.x,i.y,i.z).scaleInPlace(200);const l=[new BABYLON.Color4(0,0,1,1)];const o=[h,n];const a=this.ks.getForwardRay().direction.negateInPlace().normalize();const r=s.pickedPoint;const m=s.pickedMesh;if(m==null){return}let u=0;let c=true;var f=new BABYLON.Vector3(.05,.05,.05);if(m.name=="Cylinder"){console.log("CYLINDER");console.log(m);this.It=true;this.Ze(m);if(!this.os.isPlaying){this.os.attachToMesh(m);this.os.play(true)}console.log(m);let t=Math.random()*200*i.x;let s=Math.random()*200;let e=Math.random()*200*i.z}else{}}hi(t){let s=BABYLON.ParticleSystem.Parse(t,scene,"");s.disposeOnStop=true;s.emitter=this;s.start(1)}Ze(t){let s=t._children[0];explosionParticleSystem.systems.forEach(this.hi.bind(s));let e=Math.random()*6+4;t.metadata.physicsBody.setLinearVelocity(new Ammo.btVector3(0,e,0));let i={_soundExplosion:this._e,_mesh:t,_explodeZone:s};this.ni(t,s)}ni(t,s){if(this.S!=null){this.S.li()}this.S=BABYLON.ParticleSystem.Parse(this.o,scene,"");let e=this._e.clone();e.attachToMesh(t.metadata._root);e.play(true);setTimeout((function(t,s){t.emitter=s;t.start(1)}),1500,this.S,s)}oi(){setTimeout((function(t){t.metadata["_soundExplosion"].play(true);explosionParticleSystem.systems.forEach((s=>{let e=BABYLON.ParticleSystem.Parse(s,scene,"");e.disposeOnStop=true;e.emitter=t;e.start(1)}))}),5e3,this)}ai(t,s,e,i=1,h="sphere",n=1,l=1,o={x:0,y:0,z:0}){let a=null;a=new Ammo.btSphereShape(n);const r=new Ammo.btVector3(0,0,0);a.calculateLocalInertia(i,r);a.setMargin(0);const m=new Ammo.btTransform;m.setIdentity();const u=t[0].position;m.setOrigin(new Ammo.btVector3(e.x,e.y,e.z));const c=new Ammo.btDefaultMotionState(m);const f=new Ammo.btRigidBodyConstructionInfo(i,c,a,r);const B=new Ammo.btRigidBody(f);let w=new BABYLON.Vector3(o.x,o.y,o.z);w.scaleInPlace(l);B.setFriction(100);B.setDamping(.5,.5);B.setLinearVelocity(new Ammo.btVector3(w.x,w.y,w.z));B.objectMesh=t[0];for(let e in t){t[e].metadata={physicsBody:null,tag:s,_callback:null,collisionCount:0,_sound:null,_soundExplosion:null};t[e].metadata.physicsBody=B}window.ammoPlugin.world.addRigidBody(B);if(s=="grenadethrow"){let s=this.be.clone();s.attachToMesh(t[0]);t[0].metadata["_callback"]=this.oi.bind(t[0]);t[0].metadata["_sound"]=s;t[0].metadata["_soundExplosion"]=this._e.clone();this.$.push(t[0]);t[0].metadata["_callback"]()}this.meshes.push(t[0])}ri(t,s,e,i=1,h="box",n=null){let l=null;if(n==null){let s=t[1]._boundingInfo.boundingBox.maximum;let e=t[1]._boundingInfo.boundingBox.minimum;let i=Math.abs(s.y)+Math.abs(e.y);let h=Math.abs(s.x)+Math.abs(e.x);let l=Math.abs(s.z)+Math.abs(e.z);n={x:h,y:i,z:l}}switch(h){case"box":l=new Ammo.btBoxShape(new Ammo.btVector3(n.x/2,n.y,n.z/2));break;default:break}const o=new Ammo.btVector3(0,0,0);l.calculateLocalInertia(i,o);l.setMargin(0);const a=new Ammo.btTransform;a.setIdentity();const r=t[0].position;a.setOrigin(new Ammo.btVector3(e.x,e.y,e.z));const m=new Ammo.btDefaultMotionState(a);const u=new Ammo.btRigidBodyConstructionInfo(i,m,l,o);const c=new Ammo.btRigidBody(u);c.objectMesh=t[0];for(let e in t){t[e].metadata={physicsBody:null,tag:s};t[e].metadata.physicsBody=c}window.ammoPlugin.world.addRigidBody(c);this.meshes.push(t[0])}mi(t,s,e,i=0){for(let s in t){if(t[s].name=="__root__"){continue}let e=t[s].getVerticesData(BABYLON.VertexBuffer.PositionKind);let h,n=new Ammo.btTriangleMesh;let l=new Ammo.btVector3(0,0,0);let o=new Ammo.btVector3(0,0,0);let a=new Ammo.btVector3(0,0,0);let r=[];for(let t=0;t<e.length;t+=3){r.push({x:e[t],y:e[t+1],z:e[t+2]})}for(let t=0;t<r.length-3;t+=3){l.setX(r[t].x);l.setY(r[t].y);l.setZ(r[t].z);o.setX(r[t+1].x);o.setY(r[t+1].y);o.setZ(r[t+1].z);a.setX(r[t+2].x);a.setY(r[t+2].y);a.setZ(r[t+2].z);n.addTriangle(l,o,a,true)}Ammo.destroy(l);Ammo.destroy(o);Ammo.destroy(a);let m=new Ammo.btConvexTriangleMeshShape(n,true);const u=new Ammo.btVector3(0,0,0);m.calculateLocalInertia(i,u);m.setMargin(0);const c=new Ammo.btTransform;c.setIdentity();const f=t[s].position;c.setOrigin(new Ammo.btVector3(f.x,f.y,f.z));const B=new Ammo.btDefaultMotionState(c);const w=new Ammo.btRigidBodyConstructionInfo(i,B,m,u);const A=new Ammo.btRigidBody(w);t[s].metadata={physicsBody:null};t[s].metadata.physicsBody=A;let d=t[0].clone();d.metadata={physicsBody:null};d.metadata.physicsBody=A;window.ammoPlugin.world.addRigidBody(A);let p={meshes:[]};p.meshes.push(d);p.meshes.push(t[s]);this.meshes.push(p.meshes[0])}}async Vs(t,s){let e=t.getVerticesData(BABYLON.VertexBuffer.PositionKind);let i,h=new Ammo.btTriangleMesh;let n=new Ammo.btVector3(0,0,0);let l=new Ammo.btVector3(0,0,0);let o=new Ammo.btVector3(0,0,0);let a=[];for(let t=0;t<e.length;t+=3){a.push({x:e[t],y:e[t+1],z:e[t+2]})}for(let t=0;t<a.length-3;t+=3){n.setX(a[t].x);n.setY(a[t].y);n.setZ(a[t].z);l.setX(a[t+1].x);l.setY(a[t+1].y);l.setZ(a[t+1].z);o.setX(a[t+2].x);o.setY(a[t+2].y);o.setZ(a[t+2].z);h.addTriangle(n,l,o,true)}Ammo.destroy(n);Ammo.destroy(l);Ammo.destroy(o);this[s]=new Ammo.btConvexTriangleMeshShape(h,true)}Qs(t,s,e,i,h=0,n={qs:1,direction:{x:1,y:1,z:1},Xs:[0,0]}){const l=new Ammo.btVector3(0,0,0);i.calculateLocalInertia(h,l);i.setMargin(0);const o=new Ammo.btTransform;o.setIdentity();const a=t[0].position;o.setOrigin(new Ammo.btVector3(e.x,e.y,e.z));const r=new Ammo.btDefaultMotionState(o);const m=new Ammo.btRigidBodyConstructionInfo(h,r,i,l);const u=new Ammo.btRigidBody(m);let c=new BABYLON.Vector3(n.direction.x,n.direction.y,n.direction.z).scaleInPlace(n.qs);u.setFriction(100);u.setDamping(n.Xs[0],n.Xs[1]);u.setLinearVelocity(new Ammo.btVector3(c.x,c.y,c.z));u.objectMesh=t[0];if(s=="grenadethrow"){for(let e in t){t[e].metadata={physicsBody:null,tag:s,_callback:null,collisionCount:0,_sound:null,_soundExplosion:null};t[e].metadata.physicsBody=u;t[e].rotationQuaternion=null}let e=this.be.clone();e.attachToMesh(t[0]);t[0].metadata["_callback"]=this.oi.bind(t[0]);t[0].metadata["_sound"]=e;t[0].metadata["_soundExplosion"]=this._e.clone();this.$.push(t[0]);t[0].metadata["_callback"]()}else{for(let i in t){t[i].metadata={physicsBody:null,tag:s,initialPosition:{x:e.x,y:e.y,z:e.z}};t[i].rotationQuaternion=null;t[i].metadata.physicsBody=u}}window.ammoPlugin.world.addRigidBody(u);this.meshes.push(t[0])}Us(t,s,e,i=0,h={qs:1.1,direction:{x:0,y:-1,z:0}}){let n=t[1].getVerticesData(BABYLON.VertexBuffer.PositionKind);let l,o=new Ammo.btTriangleMesh;let a=new Ammo.btVector3(0,0,0);let r=new Ammo.btVector3(0,0,0);let m=new Ammo.btVector3(0,0,0);let u=[];for(let t=0;t<n.length;t+=3){u.push({x:n[t],y:n[t+1],z:n[t+2]})}for(let t=0;t<u.length-3;t+=3){a.setX(u[t].x);a.setY(u[t].y);a.setZ(u[t].z);r.setX(u[t+1].x);r.setY(u[t+1].y);r.setZ(u[t+1].z);m.setX(u[t+2].x);m.setY(u[t+2].y);m.setZ(u[t+2].z);o.addTriangle(a,r,m,true)}Ammo.destroy(a);Ammo.destroy(r);Ammo.destroy(m);let c=new Ammo.btConvexTriangleMeshShape(o,true);const f=new Ammo.btVector3(0,0,0);c.calculateLocalInertia(i,f);c.setMargin(0);const B=new Ammo.btTransform;B.setIdentity();const w=t[0].position;B.setOrigin(new Ammo.btVector3(e.x,e.y,e.z));if(s=="barrel"){}const A=new Ammo.btDefaultMotionState(B);const d=new Ammo.btRigidBodyConstructionInfo(i,A,c,f);const p=new Ammo.btRigidBody(d);let O=new BABYLON.Vector3(h.direction.x,h.direction.y,h.direction.z).scaleInPlace(h.qs);p.setLinearVelocity(new Ammo.btVector3(O.x,O.y,O.z));p.setFriction(5);p.objectMesh=t[0];for(let e in t){t[e].metadata={tag:s,physicsBody:null,_root:t[0]};t[e].rotationQuaternion=null;t[e].metadata.physicsBody=p}window.ammoPlugin.world.addRigidBody(p);this.meshes.push(t[0])}qe(t){let s=t.movementX/2;let e=s*this.Jt;let i=e*(Math.PI/180);const h=this.O.rotationQuaternion.toEulerAngles();let n=h.x;let l=h.y+i;let o=h.z;let a=BABYLON.Quaternion.FromEulerAngles(n,l,o);this.O.rotationQuaternion=a;var r=new Ammo.btTransform;this.O.physicsImpostor.physicsBody.getMotionState().getWorldTransform(r);this.v=r;var m=t.movementY*.002*.8;this.ks.rotation=new BABYLON.Vector3(m+this.ks.rotation.x,this.ks.rotation.y,this.ks.rotation.z)}}export default Player;